{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authorization Successful</title>
    <link rel="stylesheet" href="{% static 'strava/style.css' %}">
</head>
<body>
    <div class="success-container">
        <div class="success-icon">
            <svg class="checkmark" viewBox="0 0 52 52">
                <path d="M14 27l7 7L38 17" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
        
        <h1>Authorization Successful!</h1>
        <p class="subtitle">You have successfully connected your account. You can now close this window and return to the application.</p>
        
        <div class="details">
            <div class="detail-item">
                <span class="detail-label">Status:</span>
                <span class="detail-value">âœ… Authorized</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Time:</span>
                <span class="detail-value" id="timestamp"></span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Session:</span>
                <span class="detail-value" id="session-id"></span>
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="returnToApp()">Return to App</button>
            <button class="btn btn-secondary" onclick="window.close()">Close Window</button>
        </div>
        
        <p class="footer-text">This window will automatically close in <span id="countdown">10</span> seconds</p>
    </div>

    <script>
        // Set current timestamp
        document.getElementById('timestamp').textContent = new Date().toLocaleString();
        
        // Generate a mock session ID
        document.getElementById('session-id').textContent = 'sess_' + Math.random().toString(36).substr(2, 9);
        
        // Auto-close countdown
        let countdown = 10;
        const countdownElement = document.getElementById('countdown');
        
        const timer = setInterval(() => {
            countdown--;
            countdownElement.textContent = countdown;
            
            if (countdown <= 0) {
                clearInterval(timer);
                window.close();
            }
        }, 1000);
        
        // Return to app function
        function returnToApp() {
            // Try to communicate with parent window if in popup
            if (window.opener) {
                window.opener.postMessage({ 
                    type: 'oauth_success', 
                    timestamp: new Date().toISOString() 
                }, '*');
                window.close();
            } else {
                // Fallback - try to redirect or close
                window.history.back() || window.close();
            }
        }
        
        // Handle URL parameters (e.g., ?code=abc123&state=xyz)
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('code')) {
            console.log('Authorization code received:', urlParams.get('code'));
        }
        if (urlParams.get('state')) {
            console.log('State parameter:', urlParams.get('state'));
        }
        
        // Send success message to parent window if in iframe/popup
        window.addEventListener('load', () => {
            if (window.parent !== window) {
                window.parent.postMessage({
                    type: 'oauth_complete',
                    success: true,
                    timestamp: new Date().toISOString()
                }, '*');
            }
        });
    </script>
</body>
</html>